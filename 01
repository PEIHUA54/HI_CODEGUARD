å¥½å•é¡Œ!è®“æˆ‘è§£é‡‹ä¸€ä¸‹ `GetKey` çš„ç”¨é€”å’Œç‚ºä»€éº¼éœ€è¦å®ƒã€‚

## ğŸ” GetKey çš„ç”¨é€”èªªæ˜

### ç•¶å‰ç‹€æ³åˆ†æ

çœ‹ä½ æä¾›çš„ç¨‹å¼ç¢¼,æˆ‘ç™¼ç¾æœ‰å…©å€‹ç‰ˆæœ¬:

**ç‰ˆæœ¬1 (ç°¡å–®ç‰ˆ - ä½ åŸæœ¬çš„ getCode):**

```csharp
// åªç”¨ SHA256
string rawString = sys_id + data + timeStr;
byte[] inputBytes = Encoding.UTF8.GetBytes(rawString);
using (SHA256 sha256 = SHA256.Create())
{
    byte[] hashBytes = sha256.ComputeHash(inputBytes);
    // ...
}
```

**ç‰ˆæœ¬2 (é€²éšç‰ˆ - ä½ åŸæœ¬çš„ VerifyCode æœ‰æåˆ°):**

```csharp
// ä½¿ç”¨ Salt (åŠ é¹½) å¢åŠ å®‰å…¨æ€§
byte[] saltBytes = HexStringToBytes(GetKey(sys_id));
// é€™å€‹ saltBytes å¯ä»¥è·Ÿ inputBytes çµåˆå¾Œå†é›œæ¹Š
```

-----

## â“ ç‚ºä»€éº¼æœƒæœ‰ GetKey?

ä½ åŸæœ¬æä¾›çš„ç¬¬äºŒæ®µç¨‹å¼ç¢¼æœ‰é€™è¡Œ:

```csharp
byte[] saltBytes = new byte[8];
saltBytes = HexStringToBytes(GetKey(sys_id));
```

é€™æ˜¯**åŠ é¹½(Salt)æ©Ÿåˆ¶**,ç›®çš„æ˜¯å¢åŠ å®‰å…¨æ€§ã€‚

-----

## ğŸ¤” å¯¦éš›ä¸Šéœ€è¦å—?

### ç­”æ¡ˆ:çœ‹ä½ çš„å®‰å…¨éœ€æ±‚

**å¦‚æœä½ çš„éœ€æ±‚æ˜¯ç°¡å–®çš„æˆæ¬Šç¢¼ç³»çµ±:**

- âœ… **ä¸éœ€è¦ GetKey**
- âœ… ç›´æ¥ç”¨ SHA256(SysID + Data + Time) å°±å¤ äº†
- âœ… æˆ‘æä¾›çš„å®Œæ•´ç¨‹å¼ç¢¼å·²ç¶“æ˜¯é€™å€‹ç‰ˆæœ¬(è¼ƒç°¡å–®ä½†è¶³å¤ å®‰å…¨)

**å¦‚æœä½ éœ€è¦æ›´é«˜å®‰å…¨æ€§:**

- âš ï¸ å¯ä»¥åŠ å…¥ GetKey (Saltæ©Ÿåˆ¶)
- âš ï¸ ä¸åŒç³»çµ±æœ‰ä¸åŒçš„åŠ å¯†é‡‘é‘°
- âš ï¸ æ›´é›£è¢«ç ´è§£

-----

## ğŸ”§ å…©ç¨®å¯¦ä½œæ–¹å¼æ¯”è¼ƒ

### æ–¹å¼A: ä¸ä½¿ç”¨ GetKey (æˆ‘æä¾›çš„ç‰ˆæœ¬)

```csharp
// FGetCode.cs å’Œ FVerifyCode.cs
private string GetCode(string sysId, string data, int codeLength)
{
    DateTime tryTime = DateTime.Now;
    tryTime = new DateTime(tryTime.Year, tryTime.Month, tryTime.Day,
           tryTime.Hour, tryTime.Minute, 0);
    string timeStr = tryTime.ToString("yyyy-MM-dd HH:mm:ss");

    // ç°¡å–®çµ„åˆ
    string rawString = sysId + data + timeStr;
    byte[] inputBytes = Encoding.UTF8.GetBytes(rawString);

    using (SHA256 sha256 = SHA256.Create())
    {
        byte[] hashBytes = sha256.ComputeHash(inputBytes);
        StringBuilder hex = new StringBuilder();
        foreach (byte b in hashBytes)
            hex.AppendFormat("{0:X2}", b);
        return hex.ToString().Substring(0, codeLength).ToUpper();
    }
}
```

**å„ªé»:**

- ç°¡å–®æ˜“æ‡‚
- ä¸éœ€è¦ç¶­è­·é‡‘é‘°è¡¨
- å°æ–¼ä¸€èˆ¬ä¼æ¥­æ‡‰ç”¨å·²ç¶“è¶³å¤ å®‰å…¨

-----

### æ–¹å¼B: ä½¿ç”¨ GetKey (åŠ é¹½ç‰ˆæœ¬)

å¦‚æœä½ æƒ³è¦æ›´é«˜å®‰å…¨æ€§,å¯ä»¥æ”¹æˆé€™æ¨£:

```csharp
private string GetCode(string sysId, string data, int codeLength)
{
    DateTime tryTime = DateTime.Now;
    tryTime = new DateTime(tryTime.Year, tryTime.Month, tryTime.Day,
           tryTime.Hour, tryTime.Minute, 0);
    string timeStr = tryTime.ToString("yyyy-MM-dd HH:mm:ss");

    // å–å¾—è©²ç³»çµ±çš„å°ˆå±¬é‡‘é‘°
    string systemKey = Common.GetKey(sysId);
    
    // çµ„åˆæ™‚åŠ å…¥é‡‘é‘°
    string rawString = sysId + data + timeStr + systemKey;
    byte[] inputBytes = Encoding.UTF8.GetBytes(rawString);

    using (SHA256 sha256 = SHA256.Create())
    {
        byte[] hashBytes = sha256.ComputeHash(inputBytes);
        StringBuilder hex = new StringBuilder();
        foreach (byte b in hashBytes)
            hex.AppendFormat("{0:X2}", b);
        return hex.ToString().Substring(0, codeLength).ToUpper();
    }
}
```

**å„ªé»:**

- æ›´é«˜å®‰å…¨æ€§
- ä¸åŒç³»çµ±ç”¢ç”Ÿçš„æˆæ¬Šç¢¼ç„¡æ³•äº’é€š
- å³ä½¿çŸ¥é“æ¼”ç®—æ³•ä¹Ÿé›£ä»¥å½é€ 

**ç¼ºé»:**

- éœ€è¦ç¶­è­·é‡‘é‘°è¡¨
- å¦‚æœé‡‘é‘°å¤–æ´©éœ€è¦æ›´æ–°

-----

## ğŸ’¡ æˆ‘çš„å»ºè­°

### å»ºè­°1: ç°¡å–®ç‰ˆæœ¬å°±å¤ äº† (ä¸ç”¨ GetKey)

**åŸå› :**

1. ä½ çš„æˆæ¬Šç¢¼æœ‰æ™‚æ•ˆæ€§ (MaxMinutes)
1. å·²ç¶“ä½¿ç”¨ SHA256 åŠ å¯†
1. æœ‰ç³»çµ±IDéš”é›¢
1. å°æ–¼ POS ç³»çµ±çš„ä¸»ç®¡æˆæ¬Šå ´æ™¯å·²ç¶“è¶³å¤ 

**ä½¿ç”¨æˆ‘æä¾›çš„å®Œæ•´ç¨‹å¼ç¢¼å³å¯,ä¸éœ€è¦æ”¹å‹•ã€‚**

-----

### å»ºè­°2: å¦‚æœè¦æ›´é«˜å®‰å…¨æ€§

å¦‚æœä¸»ç®¡è¦æ±‚æ›´é«˜å®‰å…¨æ€§,å¯ä»¥é€™æ¨£èª¿æ•´:

#### ä¿®æ”¹ FGetCode.cs:

```csharp
private string GetCode(string sysId, string data, int codeLength)
{
    DateTime tryTime = DateTime.Now;
    tryTime = new DateTime(tryTime.Year, tryTime.Month, tryTime.Day,
           tryTime.Hour, tryTime.Minute, 0);
    string timeStr = tryTime.ToString("yyyy-MM-dd HH:mm:ss");

    // åŠ å…¥ç³»çµ±é‡‘é‘°
    string systemKey = Common.GetKey(sysId);
    string rawString = sysId + data + timeStr + systemKey;  // â† é€™è£¡åŠ å…¥ systemKey
    
    byte[] inputBytes = Encoding.UTF8.GetBytes(rawString);

    using (SHA256 sha256 = SHA256.Create())
    {
        byte[] hashBytes = sha256.ComputeHash(inputBytes);
        StringBuilder hex = new StringBuilder();
        foreach (byte b in hashBytes)
            hex.AppendFormat("{0:X2}", b);
        return hex.ToString().Substring(0, codeLength).ToUpper();
    }
}
```

#### ä¿®æ”¹ FVerifyCode.cs (åŒæ¨£çš„æ”¹æ³•):

```csharp
private bool VerifyCode(string sysId, string data, string inputCode, int codeLength, int maxMinutes)
{
    string codeCandidate = "";
    DateTime now = DateTime.Now;

    for (int i = 0; i <= maxMinutes; i++)
    {
        DateTime tryTime = now.AddMinutes(-i);
        var fixedTime = new DateTime(tryTime.Year, tryTime.Month, tryTime.Day, 
            tryTime.Hour, tryTime.Minute, 0);
        string timeStr = fixedTime.ToString("yyyy-MM-dd HH:mm:ss");

        // åŠ å…¥ç³»çµ±é‡‘é‘°
        string systemKey = Common.GetKey(sysId);
        string rawString = sysId + data + timeStr + systemKey;  // â† é€™è£¡åŠ å…¥ systemKey
        
        byte[] inputBytes = Encoding.UTF8.GetBytes(rawString);

        using (SHA256 sha256 = SHA256.Create())
        {
            byte[] hashBytes = sha256.ComputeHash(inputBytes);
            StringBuilder hex = new StringBuilder();
            foreach (byte b in hashBytes)
                hex.AppendFormat("{0:X2}", b);
            codeCandidate = hex.ToString().Substring(0, codeLength).ToUpper();
        }

        if (codeCandidate.Equals(inputCode.ToUpper(), StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }
    }

    return false;
}
```

-----

## âœ… çµè«–

### æˆ‘çš„å»ºè­°:

**å…ˆä½¿ç”¨ç°¡å–®ç‰ˆæœ¬(æˆ‘å·²æä¾›çš„å®Œæ•´ç¨‹å¼ç¢¼)**

- ä¸éœ€è¦ GetKey
- å·²ç¶“å¤ å®‰å…¨
- ç¨‹å¼ç¢¼æ›´ç°¡æ½”
- ä¸éœ€è¦ç¶­è­·é‡‘é‘°

**å¦‚æœä¸»ç®¡è¦æ±‚æ›´é«˜å®‰å…¨æ€§,å†åŠ å…¥ GetKey**

- åªéœ€è¦åœ¨å…©å€‹åœ°æ–¹åŠ å…¥ `+ systemKey`
- Common.GetKey æˆ‘å·²ç¶“æä¾›äº†

-----

## ğŸ“Œ ç¸½çµ:ä½ ç¾åœ¨éœ€è¦åšä»€éº¼?

**ç›´æ¥ä½¿ç”¨æˆ‘æä¾›çš„å®Œæ•´ç¨‹å¼ç¢¼å³å¯!**

æˆ‘æä¾›çš„ç‰ˆæœ¬:

- âœ… å·²ç¶“å¾ˆå®‰å…¨ (SHA256 + æ™‚æ•ˆæ€§)
- âœ… ä¸éœ€è¦ GetKey ä¹Ÿå¾ˆå®‰å…¨
- âœ… ç¨‹å¼ç¢¼ç°¡å–®æ˜“æ‡‚
- âœ… ç¬¦åˆä½ çš„éœ€æ±‚

**GetKey æ˜¯å¯é¸çš„é¡å¤–å®‰å…¨æ©Ÿåˆ¶,ä¸æ˜¯å¿…è¦çš„!**

å•Š!æˆ‘æ˜ç™½äº†!è®“æˆ‘é‡æ–°çœ‹ä½ ä¸»ç®¡æä¾›çš„ç¨‹å¼ç¢¼:

## ğŸ” ä¸»ç®¡æä¾›çš„ç¨‹å¼ç¢¼åˆ†æ

ä½ ä¸»ç®¡çµ¦çš„**ç¬¬äºŒæ®µç¨‹å¼ç¢¼**æœ‰é€™å¹¾è¡Œ:

```csharp
byte[] saltBytes = new byte[8];
saltBytes = HexStringToBytes(GetKey(sys_id));
```

ä½†æ˜¯:

1. **saltBytes è¢«å®£å‘Šäº†,ä½†å¾Œé¢æ²’ç”¨åˆ°!**
1. GetKey è¢«å‘¼å«äº†,ä½†ä¸»ç®¡æ²’æä¾›é€™å€‹æ–¹æ³•çš„å¯¦ä½œ

-----

## ğŸ’¡ çœŸç›¸:GetKey å¯èƒ½æ˜¯**æ­·å²éºç•™ç¨‹å¼ç¢¼**

### æˆ‘çš„åˆ¤æ–·:

ä¸»ç®¡å¯èƒ½æ˜¯å¾èˆŠå°ˆæ¡ˆè¤‡è£½ç¨‹å¼ç¢¼éä¾†,ä½†:

- **å¯¦éš›ä¸Šæ²’ç”¨åˆ° saltBytes**
- **GetKey å¯ä»¥æ‹¿æ‰**

è®“æˆ‘æª¢æŸ¥ä¸»ç®¡çš„ç¨‹å¼ç¢¼:

```csharp
// ä¸»ç®¡çš„ VerifyCode
public bool VerifyCode(string sys_id, string data, string inputCode, int pwd_length, int maxMinutes)
{
    for (int i = 0; i <= maxMinutes; i++)
    {
        DateTime tryTime = now.AddMinutes(-i);
        var fixedTime = new DateTime(...);
        string timeStr = fixedTime.ToString("yyyy-MM-dd HH:mm:ss");

        string rawString = sys_id + data + timeStr;  // â† çœ‹!é€™è£¡åªç”¨äº† sys_id + data + timeStr
        byte[] hashBytes;

        byte[] saltBytes = new byte[8];
        saltBytes = HexStringToBytes(GetKey(sys_id));  // â† é€™å…©è¡Œå®£å‘Šäº†ä½†æ²’ç”¨åˆ°!

        byte[] inputBytes = Encoding.UTF8.GetBytes(rawString);

        // é›œæ¹Šè™•ç†
        using (SHA256 sha256 = SHA256.Create())
        {
            hashBytes = sha256.ComputeHash(inputBytes);  // â† ç›´æ¥ç”¨ inputBytes,æ²’ç”¨ saltBytes!
            // ...
        }
    }
}
```

**ç™¼ç¾å•é¡Œäº†å—?**

- `saltBytes` è¢«å»ºç«‹äº†
- `GetKey()` è¢«å‘¼å«äº†
- **ä½†æ˜¯ saltBytes å¾ä¾†æ²’è¢«ç”¨åœ¨ SHA256 çš„è¨ˆç®—ä¸­!**

-----

## ğŸ¯ çµè«–:GetKey **ä¸éœ€è¦!**

### ç­”æ¡ˆå¾ˆæ˜ç¢º:

**GetKey å’Œ saltBytes æ˜¯ç„¡æ•ˆç¨‹å¼ç¢¼,å¯ä»¥å®Œå…¨ç§»é™¤!**

ä¸»ç®¡å¯èƒ½:

1. å¾èˆŠå°ˆæ¡ˆè¤‡è£½ç¨‹å¼ç¢¼
1. åŸæœ¬æƒ³ç”¨ Salt æ©Ÿåˆ¶ä½†å¾Œä¾†æ²’å¯¦ä½œ
1. å¿˜è¨˜åˆªé™¤é€™å…©è¡Œç„¡æ•ˆç¨‹å¼ç¢¼

-----

## âœ… æ­£ç¢ºçš„åšæ³•

### ä½ åªéœ€è¦é€™æ¨£:

**å®Œå…¨ä¸éœ€è¦ GetKey,ä¸éœ€è¦ saltBytes,ä¸éœ€è¦ HexStringToBytes**

æˆ‘æä¾›çµ¦ä½ çš„å®Œæ•´ç¨‹å¼ç¢¼å·²ç¶“æ˜¯**æ­£ç¢ºä¸”ç²¾ç°¡ç‰ˆæœ¬**:

```csharp
// FGetCode.cs
private string GetCode(string sysId, string data, int codeLength)
{
    DateTime tryTime = DateTime.Now;
    tryTime = new DateTime(tryTime.Year, tryTime.Month, tryTime.Day,
           tryTime.Hour, tryTime.Minute, 0);
    string timeStr = tryTime.ToString("yyyy-MM-dd HH:mm:ss");

    string rawString = sysId + data + timeStr;  // â† å°±é€™éº¼ç°¡å–®!
    byte[] inputBytes = Encoding.UTF8.GetBytes(rawString);

    using (SHA256 sha256 = SHA256.Create())
    {
        byte[] hashBytes = sha256.ComputeHash(inputBytes);
        StringBuilder hex = new StringBuilder();
        foreach (byte b in hashBytes)
            hex.AppendFormat("{0:X2}", b);
        return hex.ToString().Substring(0, codeLength).ToUpper();
    }
}
```

-----

## ğŸ“ ä¿®æ­£å¾Œçš„ Common.cs

æ—¢ç„¶ä¸éœ€è¦ GetKey,Common.cs å¯ä»¥ç°¡åŒ–æˆ:

```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace HI_CODEGUARD_DLL
{
    public class Common
    {
        /// <summary>
        /// å›æ‡‰ä»£ç¢¼å¸¸æ•¸
        /// </summary>
        public class Codes
        {
            /// <summary>æˆåŠŸ</summary>
            public const string SUCCESS = "0000";
            /// <summary>ç³»çµ±éŒ¯èª¤</summary>
            public const string SYSTEM_ERROR = "9999";
            /// <summary>åƒæ•¸éŒ¯èª¤</summary>
            public const string PARAMETER_ERROR = "1001";
            /// <summary>é©—è­‰å¤±æ•—</summary>
            public const string VERIFY_FAILED = "1002";
        }
    }
}
```

**å°±é€™æ¨£!ä¸éœ€è¦ GetKey,ä¸éœ€è¦ HexStringToBytes!**

-----

## ğŸ¤” å¦‚æœä½ é‚„æ˜¯æƒ³ä¿ç•™ GetKey ä»¥é˜²è¬ä¸€â€¦

å¦‚æœä½ æ“”å¿ƒä¸»ç®¡æœ‰å…¶ä»–ç”¨é€”,å¯ä»¥ä¿ç•™åœ¨ Common.cs ä½†**ä¸ä½¿ç”¨**:

```csharp
public class Common
{
    public class Codes
    {
        public const string SUCCESS = "0000";
        public const string SYSTEM_ERROR = "9999";
        public const string PARAMETER_ERROR = "1001";
        public const string VERIFY_FAILED = "1002";
    }

    // ä¿ç•™ä½†ä¸ä½¿ç”¨(ä»¥é˜²è¬ä¸€ä¸»ç®¡æœ‰å…¶ä»–ç”¨é€”)
    public static string GetKey(string sysId)
    {
        Dictionary<string, string> keyMap = new Dictionary<string, string>
        {
            { "HI_POS", "A1B2C3D4E5F67890" },
            { "HI_WMS", "F1E2D3C4B5A67890" },
            { "HI_APACCESS", "1234567890ABCDEF" }
        };

        if (keyMap.ContainsKey(sysId))
            return keyMap[sysId];

        return "0123456789ABCDEF";
    }

    public static byte[] HexStringToBytes(string hex)
    {
        if (string.IsNullOrEmpty(hex))
            return new byte[0];

        int length = hex.Length;
        byte[] bytes = new byte[length / 2];
        for (int i = 0; i < length; i += 2)
        {
            bytes[i / 2] = Convert.ToByte(hex.Substring(i, 2), 16);
        }
        return bytes;
    }
}
```

-----

## ğŸ¯ æœ€çµ‚ç­”æ¡ˆ

### GetKey æ˜¯ä»€éº¼?

**ç­”:ä¸»ç®¡è¤‡è£½ç¨‹å¼ç¢¼æ™‚çš„æ­·å²éºç•™,å¯¦éš›ä¸Šæ²’æœ‰ç”¨åˆ°!**

### ä½ éœ€è¦å¯¦ä½œ GetKey å—?

**ç­”:ä¸éœ€è¦!å¯ä»¥å®Œå…¨ç§»é™¤!**

### å¦‚æœä¸»ç®¡å•èµ·?

**ç­”:ã€Œä¸»ç®¡,æˆ‘çœ‹ä½ çš„ç¨‹å¼ç¢¼ saltBytes å®£å‘Šäº†ä½†æ²’ç”¨åœ¨ SHA256 é‹ç®—ä¸­,æ‰€ä»¥æˆ‘æŠŠ GetKey ç›¸é—œçš„ç¨‹å¼ç¢¼ç§»é™¤äº†,è®“ç¨‹å¼ç¢¼æ›´ç²¾ç°¡ã€‚å¦‚æœæœ‰éœ€è¦ç”¨åˆ° Salt æ©Ÿåˆ¶,æˆ‘å†åŠ å›ä¾†ã€‚ã€**

-----

**ç¸½çµ:ç›´æ¥ç”¨æˆ‘æä¾›çš„å®Œæ•´ç¨‹å¼ç¢¼,GetKey ç›¸é—œçš„éƒ½å¯ä»¥ä¸ç†æœƒ!** ğŸ˜Šâ€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹